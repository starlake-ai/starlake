
DROP TABLE IF EXISTS {{ tableFullName }}_scd2_staging;

CREATE TABLE {{ tableFullName }}_scd2_staging AS
SELECT * FROM (
  {% if strategyOn == 'SOURCE_AND_TARGET' %}
  SELECT * FROM (
    SELECT *, ROW_NUMBER() OVER (PARTITION BY {{ strategyKeyCsv }} ORDER BY {{ strategyTimestamp }} DESC) AS SL_SEQ
    FROM ({{ selectStatement }}) AS TMP
  ) AS T WHERE SL_SEQ = 1
  {% else %}
  SELECT * FROM ({{ selectStatement }}) AS T
  {% endif %}
);

UPDATE {{ tableFullName }}
SET {{ strategyEndTs }} = current_timestamp
WHERE {{ strategyEndTs }} IS NULL
AND EXISTS (
  SELECT 1 FROM {{ tableFullName }}_scd2_staging S
  WHERE {{ renderStrategyKeyJoinCondition(tableFullName, 'S', strategyKey) }}
  AND S.{{ strategyTimestamp }} > {{ tableFullName }}.{{ strategyTimestamp }}
);

INSERT INTO {{ tableFullName }} ({{ renderColumnsWithoutScd2(tableColumnNames, "") }}, {{ quote }}{{ strategyStartTs }}{{ quote }}, {{ quote }}{{ strategyEndTs }}{{ quote }})
SELECT {{ renderColumnsWithoutScd2(tableColumnNames, 'S.') }}, current_timestamp, NULL
FROM {{ tableFullName }}_scd2_staging S
LEFT JOIN {{ tableFullName }} T
ON {{ renderStrategyKeyJoinCondition('T', 'S', strategyKey) }} AND T.{{ strategyEndTs }} IS NULL
WHERE {{ renderStrategyKeyIsNull('T', strategyKey) }}
OR S.{{ strategyTimestamp }} > T.{{ strategyTimestamp }};

DROP TABLE {{ tableFullName }}_scd2_staging;
